# Shared tasks for Go library packages
# https://moonrepo.dev/docs/config/tasks
# yaml-language-server: $schema=https://moonrepo.dev/schemas/tasks.json

$schema: https://moonrepo.dev/schemas/tasks.json

implicitInputs:
  - "go.mod"
  - "go.sum"

fileGroups:
  sources:
    - "**/*.go"
  tests:
    - "**/*_test.go"
  configs:
    - "go.mod"
    - "go.sum"
    - ".golangci.yml"

tasks:
  go-build:
    deps:
      - "^:go-build"
    command:
      - "go"
      - "build"
      - "./..."
    inputs:
      - "@globs(sources)"
      - "go.mod"
      - "go.sum"
    outputs: []
    options:
      cache: true

  go-test:
    command:
      - "go"
      - "test"
      - "-v"
      - "./..."
    deps:
      - "^:go-build"
    inputs:
      - "@globs(sources)"
      - "@globs(tests)"
    outputs: []
    options:
      cache: true

  go-test-coverage:
    command:
      - "go"
      - "test"
      - "-v"
      - "-coverprofile=coverage.out"
      - "./..."
    deps:
      - "^:go-build"
    inputs:
      - "@globs(sources)"
      - "@globs(tests)"
    outputs:
      - "coverage.out"
    options:
      cache: true

  go-lint:
    command:
      - "golangci-lint"
      - "run"
      - "./..."
    inputs:
      - "@globs(sources)"
      - "@globs(tests)"
      - ".golangci.yml"
    outputs: []
    options:
      cache: false

  go-fmt:
    command:
      - "go"
      - "fmt"
      - "./..."
    inputs:
      - "@globs(sources)"
      - "@globs(tests)"
    outputs: []
    options:
      cache: false

  go-fmt-check:
    command:
      - "bash"
      - "-c"
      - "test -z \"$(gofmt -l .)\""
    inputs:
      - "@globs(sources)"
      - "@globs(tests)"
    outputs: []
    options:
      cache: false

  go-typecheck:
    command:
      - "go"
      - "vet"
      - "./..."
    deps:
      - "^:go-build"
    inputs:
      - "@globs(sources)"
      - "@globs(tests)"
    outputs: []
    options:
      cache: true

  go-tidy:
    command:
      - "go"
      - "mod"
      - "tidy"
    inputs:
      - "go.mod"
      - "go.sum"
    outputs:
      - "go.mod"
      - "go.sum"
    options:
      cache: false
