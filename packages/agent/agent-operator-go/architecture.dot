digraph AgentOperatorArchitecture {
  // Graph settings
  rankdir=TB;
  compound=true;
  newrank=true;
  splines=true;
  nodesep=0.6;
  ranksep=0.8;
  fontname="Arial";
  label=<<TABLE BORDER="0" CELLBORDER="0"><TR><TD><B><FONT POINT-SIZE="16">Agent Operator Architecture</FONT></B></TD></TR><TR><TD><FONT POINT-SIZE="11" COLOR="#666666">agent.xonovex.com/v1alpha1</FONT></TD></TR></TABLE>>;
  labelloc=t;

  // Default styles
  node [shape=box, style="rounded,filled", fontname="Arial", fontsize=10];
  edge [fontname="Arial", fontsize=8, color="#78909c"];

  // ─── User ──────────────────────────────────────────────────────────
  user [label="User / CI Pipeline", shape=house, fillcolor="#e8eaf6"];

  // ─── CRDs ──────────────────────────────────────────────────────────
  subgraph cluster_crds {
    label=<<B>Custom Resources (CRDs)</B>>;
    style=filled; fillcolor="#fff8e1"; fontname="Arial"; fontsize=11;

    agentrun [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>AgentRun</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">agent: claude | opencode</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">repository: {url, branch, commit}</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">worktree: {branch, sourceBranch}</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">workspaceRef: → AgentWorkspace</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">prompt, timeout, image, resources</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">providerRef | provider (inline)</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">nodeSelector, tolerations, env</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#ffcc80"
    ];

    agentworkspace [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>AgentWorkspace</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">repository: {url, branch, commit}</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">storageClass, storageSize</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">sharedVolumes: [{name, mountPath, size}]</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">status: Pending → Initializing → Ready</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#fff176"
    ];

    agentprovider [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>AgentProvider</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">agentTypes, displayName</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">authTokenSecretRef</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">environment, cliArgs</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">status.ready: bool</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#ffe0b2"
    ];

    agentconfig [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>AgentConfig</B>  <FONT POINT-SIZE="7" COLOR="#999">(1 per ns)</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">defaultAgent, defaultProviders</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">defaultImage, defaultTimeout</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">storageClass, storageSize</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8" COLOR="#555">defaultResources, env</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#ffe0b2"
    ];
  }

  // ─── Webhooks + Controller Manager side by side ────────────────────
  subgraph cluster_webhooks {
    label=<<B>Admission Webhooks</B>>;
    style=filled; fillcolor="#fce4ec"; fontname="Arial"; fontsize=10;

    wh_run [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>AgentRun Webhook</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">Default: agent=claude, timeout=1h</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">Validate: type, URL/workspaceRef, no conflicts</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#f8bbd0"
    ];
    wh_workspace [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>AgentWorkspace Webhook</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">Default: storageSize=10Gi, shared=1Gi</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">Validate: URL, shared volume names</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#f8bbd0"
    ];
    wh_provider [label="AgentProvider\nWebhook", fillcolor="#f8bbd0"];
    wh_config [label="AgentConfig\nWebhook", fillcolor="#f8bbd0"];
  }

  subgraph cluster_manager {
    label=<<B>Controller Manager</B>  <FONT POINT-SIZE="8" COLOR="#666">:8081 health/ready</FONT>>;
    style=filled; fillcolor="#e8f5e9"; fontname="Arial"; fontsize=11;

    ctrl_run [label=<<B>AgentRun Reconciler</B>>, fillcolor="#a5d6a7"];
    ctrl_workspace [label=<<B>AgentWorkspace Reconciler</B>>, fillcolor="#a5d6a7"];
    ctrl_provider [label="AgentProvider\nReconciler", fillcolor="#c8e6c9"];
    ctrl_config [label="AgentConfig\nReconciler", fillcolor="#c8e6c9"];
  }

  // ─── Standalone Reconciliation Steps ────────────────────────────────
  subgraph cluster_reconcile {
    label=<<B>AgentRun Standalone Reconciliation</B>>;
    style=filled; fillcolor="#f5f5f5"; fontname="Arial"; fontsize=11;

    subgraph cluster_resolver {
      label=<<B>resolver</B>>; style=filled; fillcolor="#ede7f6"; fontname="Arial"; fontsize=10;

      resolve_config [label="1. ResolveConfig\n(list AgentConfig in ns)", fillcolor="#d1c4e9", fontsize=9];
      resolve_provider [
        label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
          <TR><TD><B>2. ResolveProvider</B></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">inline → providerRef → config default → empty</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">reads auth token from K8s Secret</FONT></TD></TR>
        </TABLE>>,
        fillcolor="#d1c4e9", fontsize=9
      ];
    }

    subgraph cluster_builder {
      label=<<B>builder</B>>; style=filled; fillcolor="#e8eaf6"; fontname="Arial"; fontsize=10;

      build_pvc [label="3. BuildPVC\n(RWO, ownerRef → AgentRun)", fillcolor="#c5cae9", fontsize=9];
      build_job [
        label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
          <TR><TD><B>4. BuildJob</B></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">BuildInitContainers (git-clone script)</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">BuildMainContainers (agent command)</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">BuildEnvVars (provider + spec merge)</FONT></TD></TR>
        </TABLE>>,
        fillcolor="#c5cae9", fontsize=9
      ];
    }

    watch_status [label="5. Watch Job Status\n→ update AgentRun phase", fillcolor="#fff9c4", fontsize=9];
  }

  // ─── Workspace Reconciliation ───────────────────────────────────────
  subgraph cluster_ws_reconcile {
    label=<<B>AgentWorkspace Reconciliation</B>>;
    style=filled; fillcolor="#fffde7"; fontname="Arial"; fontsize=11;

    ws_create_pvcs [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>1. Create PVCs</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">BuildWorkspacePVC (RWX, ownerRef → Workspace)</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">BuildSharedVolumePVC per sharedVolume entry</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#fff9c4", fontsize=9
    ];

    ws_init_job [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>2. BuildWorkspaceInitJob</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">git clone into workspace PVC</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#fff9c4", fontsize=9
    ];

    ws_watch_status [label="3. Watch Init Job\n→ set Ready | Failed", fillcolor="#fff9c4", fontsize=9];
  }

  // ─── Workspace-Aware AgentRun ─────────────────────────────────────
  subgraph cluster_ws_run {
    label=<<B>AgentRun with workspaceRef</B>>;
    style=filled; fillcolor="#e0f2f1"; fontname="Arial"; fontsize=11;

    ws_resolve [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>1. ResolveWorkspace</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">check phase == Ready (requeue if not)</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#b2dfdb", fontsize=9
    ];

    ws_build_job [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>2. BuildWorkspaceJob</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">BuildWorktreeInitContainers (git worktree add)</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">BuildWorkspaceMainContainers (agent + shared mounts)</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">Volumes: workspace PVC + shared volume PVCs</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#b2dfdb", fontsize=9
    ];

    ws_watch_run [label="3. Watch Job Status\n→ update AgentRun phase", fillcolor="#b2dfdb", fontsize=9];
  }

  // ─── K8s Resources ─────────────────────────────────────────────────
  subgraph cluster_k8s {
    label=<<B>Created Kubernetes Resources</B>>;
    style=filled; fillcolor="#e3f2fd"; fontname="Arial"; fontsize=11;

    pvc [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>PersistentVolumeClaim</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">Standalone: {name}-workspace, RWO, 10Gi</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#90caf9"
    ];

    ws_pvc [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>Workspace PVCs (RWX)</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">{ws}-ws: shared git checkout</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">{ws}-{vol}: shared config/state dirs</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#81d4fa"
    ];

    job [
      label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
        <TR><TD><B>Kubernetes Job</B></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">controllerRef → AgentRun</FONT></TD></TR>
        <TR><TD><FONT POINT-SIZE="8">backoffLimit: 0, activeDeadline</FONT></TD></TR>
      </TABLE>>,
      fillcolor="#90caf9"
    ];

    subgraph cluster_pod_standalone {
      label=<<B>Pod (Standalone)</B>  <FONT POINT-SIZE="8" COLOR="#666">(restartPolicy: Never)</FONT>>;
      style=filled; fillcolor="#bbdefb"; fontname="Arial"; fontsize=10;

      init_ctr [
        label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
          <TR><TD><B>Init: git-clone</B></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">git clone --depth 1 --single-branch</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">opt: fetch+checkout commit</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">opt: git worktree add -b</FONT></TD></TR>
        </TABLE>>,
        fillcolor="#64b5f6"
      ];

      main_ctr [
        label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
          <TR><TD><B>Main: agent</B></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">claude --permission-mode bypassPermissions</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">  [--print --prompt "task..."]</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">or: opencode [cliArgs...]</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">workingDir: /workspace</FONT></TD></TR>
        </TABLE>>,
        fillcolor="#64b5f6"
      ];
    }

    subgraph cluster_pod_workspace {
      label=<<B>Pod (Workspace)</B>  <FONT POINT-SIZE="8" COLOR="#666">(restartPolicy: Never)</FONT>>;
      style=filled; fillcolor="#b2ebf2"; fontname="Arial"; fontsize=10;

      ws_init_ctr [
        label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
          <TR><TD><B>Init: git-worktree</B></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">git worktree add /workspace-wt/{run}</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">-b {branch} {sourceBranch}</FONT></TD></TR>
        </TABLE>>,
        fillcolor="#4dd0e1"
      ];

      ws_main_ctr [
        label=<<TABLE BORDER="0" CELLBORDER="0" CELLSPACING="1">
          <TR><TD><B>Main: agent</B></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">workingDir: /workspace-wt/{run}</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">mounts: workspace PVC + shared vols</FONT></TD></TR>
          <TR><TD><FONT POINT-SIZE="8">e.g. /root/.claude, /root/.opencode</FONT></TD></TR>
        </TABLE>>,
        fillcolor="#4dd0e1"
      ];
    }
  }

  // ─── External ──────────────────────────────────────────────────────
  k8s_secret [label="K8s Secrets\n(auth tokens, git creds)", shape=cylinder, fillcolor="#d7ccc8"];
  git_repo [label="Git Repository", shape=cylinder, fillcolor="#d7ccc8"];
  ai_api [label="AI Provider API\n(Anthropic, etc.)", shape=cylinder, fillcolor="#d7ccc8"];

  // ─── AgentRun Phase Lifecycle ─────────────────────────────────────
  subgraph cluster_phases {
    label=<<B>AgentRun Phase Lifecycle</B>>;
    style=filled; fillcolor="#f3e5f5"; fontname="Arial"; fontsize=11;
    rankdir=LR;

    p_pending [label="Pending", shape=oval, fillcolor="#e1bee7"];
    p_init [label="Initializing", shape=oval, fillcolor="#ce93d8"];
    p_running [label="Running", shape=oval, fillcolor="#ab47bc", fontcolor=white];
    p_succeeded [label="Succeeded", shape=doubleoctagon, fillcolor="#66bb6a", fontcolor=white];
    p_failed [label="Failed", shape=doubleoctagon, fillcolor="#ef5350", fontcolor=white];
    p_timedout [label="TimedOut", shape=doubleoctagon, fillcolor="#ffa726", fontcolor=white];

    p_pending -> p_init [label="PVC created"];
    p_pending -> p_failed [label="provider error", style=dashed];
    p_init -> p_running [label="pod active"];
    p_running -> p_succeeded [label="job complete"];
    p_running -> p_failed [label="job failed"];
    p_running -> p_timedout [label="elapsed > timeout"];
  }

  // ─── AgentWorkspace Phase Lifecycle ───────────────────────────────
  subgraph cluster_ws_phases {
    label=<<B>AgentWorkspace Phase Lifecycle</B>>;
    style=filled; fillcolor="#e8eaf6"; fontname="Arial"; fontsize=11;
    rankdir=LR;

    wp_pending [label="Pending", shape=oval, fillcolor="#c5cae9"];
    wp_init [label="Initializing", shape=oval, fillcolor="#9fa8da"];
    wp_ready [label="Ready", shape=doubleoctagon, fillcolor="#66bb6a", fontcolor=white];
    wp_failed [label="Failed", shape=doubleoctagon, fillcolor="#ef5350", fontcolor=white];

    wp_pending -> wp_init [label="PVCs created,\ninit Job running"];
    wp_init -> wp_ready [label="clone succeeded"];
    wp_init -> wp_failed [label="clone failed"];
  }

  // ═══ MAIN FLOW EDGES ══════════════════════════════════════════════

  // User creates CRDs
  user -> agentrun [label="kubectl apply"];
  user -> agentworkspace [label="kubectl apply"];
  user -> agentprovider [style=dashed, color="#b0bec5"];
  user -> agentconfig [style=dashed, color="#b0bec5"];

  // Webhooks validate/default
  agentrun -> wh_run [label="admit", color="#c62828", fontcolor="#c62828"];
  agentworkspace -> wh_workspace [label="admit", color="#c62828", fontcolor="#c62828"];
  agentprovider -> wh_provider [color="#c62828", style=dashed];
  agentconfig -> wh_config [color="#c62828", style=dashed];

  // Controllers watch CRDs
  agentrun -> ctrl_run [label="watch", color="#2e7d32", fontcolor="#2e7d32"];
  agentworkspace -> ctrl_workspace [label="watch", color="#2e7d32", fontcolor="#2e7d32"];
  agentprovider -> ctrl_provider [color="#2e7d32", style=dashed];
  agentconfig -> ctrl_config [color="#2e7d32", style=dashed];

  // AgentRun Reconciler — standalone path
  ctrl_run -> resolve_config [label="standalone\npath", color="#4527a0", fontcolor="#4527a0"];
  ctrl_run -> resolve_provider [color="#4527a0"];
  ctrl_run -> build_pvc [color="#283593"];
  ctrl_run -> build_job [color="#283593"];
  ctrl_run -> watch_status [color="#e65100"];

  // AgentRun Reconciler — workspace path
  ctrl_run -> ws_resolve [label="workspace\npath", color="#00695c", fontcolor="#00695c"];
  ws_resolve -> ws_build_job [color="#00695c"];
  ws_build_job -> ws_watch_run [color="#00695c"];

  // AgentWorkspace Reconciler
  ctrl_workspace -> ws_create_pvcs [color="#f57f17", fontcolor="#f57f17"];
  ctrl_workspace -> ws_init_job [color="#f57f17"];
  ctrl_workspace -> ws_watch_status [color="#f57f17"];

  // Resolver → Secrets
  resolve_provider -> k8s_secret [label="read auth token", color="#5d4037", fontcolor="#5d4037"];

  // Provider reconciler → Secrets
  ctrl_provider -> k8s_secret [label="validate exists", style=dashed, color="#5d4037", fontcolor="#5d4037"];

  // Standalone builder → K8s Resources
  build_pvc -> pvc [label="create", color="#1565c0", fontcolor="#1565c0"];
  build_job -> job [label="create", color="#1565c0", fontcolor="#1565c0"];

  // Workspace builder → K8s Resources
  ws_create_pvcs -> ws_pvc [label="create RWX", color="#0277bd", fontcolor="#0277bd"];
  ws_init_job -> job [label="create init job", color="#0277bd", fontcolor="#0277bd"];
  ws_build_job -> job [label="create run job", color="#00695c", fontcolor="#00695c"];

  // Standalone Job → Pod
  job -> init_ctr [color="#1565c0"];
  init_ctr -> main_ctr [label="then"];

  // Workspace Job → Pod
  job -> ws_init_ctr [color="#0277bd"];
  ws_init_ctr -> ws_main_ctr [label="then"];

  // PVC mounts — standalone
  pvc -> init_ctr [label="/workspace", style=dashed, color="#1565c0", fontcolor="#1565c0"];
  pvc -> main_ctr [style=dashed, color="#1565c0"];

  // PVC mounts — workspace
  ws_pvc -> ws_init_ctr [label="/workspace\n+ shared vols", style=dashed, color="#0277bd", fontcolor="#0277bd"];
  ws_pvc -> ws_main_ctr [style=dashed, color="#0277bd"];

  // Pod → External systems
  init_ctr -> git_repo [label="git clone", color="#5d4037", fontcolor="#5d4037"];
  main_ctr -> ai_api [label="API calls\n(ANTHROPIC_AUTH_TOKEN)", color="#5d4037", fontcolor="#5d4037"];
  ws_main_ctr -> ai_api [color="#5d4037"];

  // Job status feedback
  job -> watch_status [label="job conditions", color="#e65100", fontcolor="#e65100", style=dashed];
  job -> ws_watch_status [style=dashed, color="#f57f17"];
  job -> ws_watch_run [style=dashed, color="#00695c"];

  // AgentRun references AgentWorkspace
  agentrun -> agentworkspace [label="workspaceRef", style=dashed, color="#ff6f00", fontcolor="#ff6f00"];

  // Layout hints
  {rank=same; agentrun; agentworkspace; agentprovider; agentconfig;}
  {rank=same; wh_run; wh_workspace; wh_provider; wh_config; ctrl_run; ctrl_workspace; ctrl_provider; ctrl_config;}
  {rank=same; pvc; ws_pvc; job;}
  {rank=same; git_repo; ai_api; k8s_secret;}
}
