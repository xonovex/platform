# Release pipeline â€” mirrors .github/workflows/release.yml

release:detect:
  stage: release-detect
  script:
    - nix develop --command bash -c "npm ci"
    - |
      DRY_RUN="${DRY_RUN:-false}"
      echo "DRY_RUN=$DRY_RUN" >> release.env

      nix develop --command npx changeset status --output=changeset-status.json 2>/dev/null || true

      if [ ! -f changeset-status.json ]; then
        echo "SHOULD_RELEASE=false" >> release.env
        echo "CHANGED_PROJECTS=[]" >> release.env
        exit 0
      fi

      PROJECTS=$(nix develop --command node -e "
        const { execSync } = require('child_process');
        const fs = require('fs');
        const path = require('path');
        const status = require('./changeset-status.json');
        const changedNames = new Set((status.releases || []).map(r => r.name));
        const moonOutput = JSON.parse(execSync('npx moon query projects', { encoding: 'utf8' }));
        const projects = [];
        for (const p of moonOutput.projects) {
          try {
            const pkg = JSON.parse(fs.readFileSync(path.join(p.source, 'package.json'), 'utf8'));
            if (pkg.name && changedNames.has(pkg.name) && !pkg.private) {
              projects.push(p.id);
            }
          } catch {}
        }
        console.log(JSON.stringify(projects));
      ")

      if [ "$PROJECTS" = "[]" ]; then
        echo "SHOULD_RELEASE=false" >> release.env
      else
        echo "SHOULD_RELEASE=true" >> release.env
      fi
      echo "CHANGED_PROJECTS=$PROJECTS" >> release.env
  artifacts:
    reports:
      dotenv: release.env
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TITLE =~ /^chore: version packages/'

release:validate:
  stage: release-validate
  extends: .workspace_cache
  needs: ["release:detect"]
  script:
    - |
      if [ "$SHOULD_RELEASE" != "true" ]; then
        echo "No packages to validate"
        exit 0
      fi
    - |
      TARGETS=$(echo "$CHANGED_PROJECTS" | jq -r '.[] | . + ":ci-prepare"' | tr '\n' ' ')
      nix develop --command bash -c "npm ci && npx moon ci $TARGETS"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TITLE =~ /^chore: version packages/'

release:publish:
  stage: release-publish
  extends: .workspace_cache
  needs: ["release:detect", "release:validate"]
  script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - |
      if [ "$SHOULD_RELEASE" != "true" ]; then
        echo "No packages to publish"
        exit 0
      fi
    - |
      if [ "$DRY_RUN" = "true" ]; then
        TARGETS=$(echo "$CHANGED_PROJECTS" | jq -r '.[] | . + ":ci-publish-dry-run"' | tr '\n' ' ')
      else
        TARGETS=$(echo "$CHANGED_PROJECTS" | jq -r '.[] | . + ":ci-publish"' | tr '\n' ' ')
      fi
      nix develop --command bash -c "npm ci && npx moon ci $TARGETS"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TITLE =~ /^chore: version packages/'
