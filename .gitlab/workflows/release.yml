# Release pipeline â€” mirrors .github/workflows/release.yml

release:
  stage: release
  extends: .workspace_cache
  script:
    - |
      PROJECTS=$(npx tsx scripts/version-detect.ts HEAD~1 2>/dev/null)
      if [ "$PROJECTS" = "[]" ]; then
        echo "No packages with version changes"
        exit 0
      fi
      if [ "$DRY_RUN" = "true" ]; then
        TARGETS=$(echo "$PROJECTS" | jq -r '.[] | . + ":ci-publish-dry-run"' | tr '\n' ' ')
      else
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
        TARGETS=$(echo "$PROJECTS" | jq -r '.[] | . + ":ci-publish"' | tr '\n' ' ')
      fi
      npx moon ci --concurrency 1 $TARGETS
  rules:
    - if: "$CI_COMMIT_TAG =~ /^v/"
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TITLE =~ /^chore: version packages/'
