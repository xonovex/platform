name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Perform a dry run (no actual publishing)"
        type: boolean
        default: true
  pull_request:
    types: [closed]
    branches: [main]

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && contains(github.event.pull_request.title, 'version packages'))
    outputs:
      should_release: ${{ steps.detect.outputs.should_release }}
      dry_run: ${{ steps.detect.outputs.dry_run }}
      changed_projects: ${{ steps.detect.outputs.changed_projects }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: /nix
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - uses: nixbuild/nix-quick-install-action@v34
        with:
          nix_conf: |
            build-users-group =

      - name: Install dependencies
        run: nix develop --command npm ci

      - name: Detect changed packages
        id: detect
        run: |
          DRY_RUN="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run || 'false' }}"
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT

          nix develop --command npx changeset status --output=changeset-status.json 2>/dev/null || true

          if [ ! -f changeset-status.json ]; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "changed_projects=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          PROJECTS=$(nix develop --command node -e "
            const { execSync } = require('child_process');
            const fs = require('fs');
            const path = require('path');
            const status = require('./changeset-status.json');
            const changedNames = new Set((status.releases || []).map(r => r.name));
            const moonOutput = JSON.parse(execSync('npx moon query projects', { encoding: 'utf8' }));
            const projects = [];
            for (const p of moonOutput.projects) {
              try {
                const pkg = JSON.parse(fs.readFileSync(path.join(p.source, 'package.json'), 'utf8'));
                if (pkg.name && changedNames.has(pkg.name) && !pkg.private) {
                  projects.push(p.id);
                }
              } catch {}
            }
            console.log(JSON.stringify(projects));
          ")

          if [ "$PROJECTS" = "[]" ]; then
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi
          echo "changed_projects=$PROJECTS" >> $GITHUB_OUTPUT

  validate:
    name: Validate
    runs-on: ubuntu-latest
    needs: [detect]
    if: needs.detect.outputs.should_release == 'true'

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: /nix
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - uses: nixbuild/nix-quick-install-action@v34
        with:
          nix_conf: |
            build-users-group =

      - uses: actions/cache@v4
        with:
          path: |
            .moon/cache
            node_modules
          key: npm-moon-${{ runner.os }}-${{ hashFiles('package-lock.json', '.moon/**/*.yml') }}
          restore-keys: |
            npm-moon-${{ runner.os }}-

      - uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: go-mod-${{ runner.os }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-mod-${{ runner.os }}-

      - run: nix develop --command bash -c "npm install && npx moon ci :build :test :lint :typecheck :go-build :go-test :go-lint :go-typecheck"

      - uses: appthrust/moon-ci-retrospect@v1
        if: success() || failure()

      - name: Prepublish check
        run: nix develop --command npm run prepublish:check

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [detect, validate]
    if: needs.detect.outputs.should_release == 'true'
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: /nix
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - uses: nixbuild/nix-quick-install-action@v34
        with:
          nix_conf: |
            build-users-group =

      - uses: actions/setup-node@v6
        with:
          registry-url: "https://registry.npmjs.org"

      - run: nix develop --command npm ci

      - name: Publish changed packages
        if: needs.detect.outputs.dry_run != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECTS='${{ needs.detect.outputs.changed_projects }}'

          for project in $(echo "$PROJECTS" | jq -r '.[]'); do
            echo "::group::Publishing $project"
            nix develop --command npx moon run "$project:ci-publish"
            echo "::endgroup::"
          done

      - name: Dry run
        if: needs.detect.outputs.dry_run == 'true'
        run: |
          PROJECTS='${{ needs.detect.outputs.changed_projects }}'

          for project in $(echo "$PROJECTS" | jq -r '.[]'); do
            echo "::group::Dry run $project"
            nix develop --command npx moon run "$project:ci-publish-dry-run"
            echo "::endgroup::"
          done

      - uses: appthrust/moon-ci-retrospect@v1
        if: success() || failure()
